name: TripEase CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

env:
  PHP_VERSION: "7.4"
  MYSQL_VERSION: "5.7"
  NODE_VERSION: "16"

jobs:
  # Code Quality & Linting
  code-quality:
    name: Code Quality Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: mbstring, pdo, pdo_mysql, gd, zip
          coverage: xdebug
          tools: composer:v2

      - name: Validate composer.json
        run: composer validate --strict

      - name: Cache Composer dependencies
        uses: actions/cache@v3
        with:
          path: vendor
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-composer-

      - name: Install dependencies
        run: composer install --prefer-dist --no-progress --no-suggest

      - name: Check PHP Syntax
        run: find . -name "*.php" -not -path "./vendor/*" -exec php -l {} \;

      - name: Run PHP Code Sniffer (if available)
        continue-on-error: true
        run: |
          if [ -f "vendor/bin/phpcs" ]; then
            vendor/bin/phpcs --standard=PSR12 --ignore=vendor/ . || true
          else
            echo "PHP Code Sniffer not installed, skipping..."
          fi

  # Security Scanning
  security-scan:
    name: Security Vulnerability Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: mbstring, pdo, pdo_mysql
          tools: composer:v2

      - name: Install dependencies
        run: composer install --prefer-dist --no-progress

      - name: Security Check (Composer)
        run: |
          composer audit || echo "No security audit available in this Composer version"

      - name: Check for hardcoded secrets
        run: |
          echo "Checking for potential hardcoded secrets..."
          ! grep -rn "password.*=" --include="*.php" --exclude-dir=vendor . | grep -v "password_hash\|password_verify\|'password'" || echo "Warning: Potential hardcoded passwords found"

  # Unit & Integration Tests
  test:
    name: Run Tests (PHP ${{ matrix.php-version }})
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        php-version: ["7.4", "8.0", "8.1"]

    services:
      mysql:
        image: mysql:5.7
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: tripease_test
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php-version }}
          extensions: mbstring, pdo, pdo_mysql, gd, zip
          coverage: xdebug
          tools: composer:v2

      - name: Cache Composer dependencies
        uses: actions/cache@v3
        with:
          path: vendor
          key: ${{ runner.os }}-php${{ matrix.php-version }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-php${{ matrix.php-version }}-composer-

      - name: Install dependencies
        run: composer install --prefer-dist --no-progress

      - name: Wait for MySQL
        run: |
          for i in {1..30}; do
            mysqladmin ping -h 127.0.0.1 -P 3306 -u root -proot && break
            echo "Waiting for MySQL..."
            sleep 2
          done

      - name: Setup test database
        env:
          DB_HOST: 127.0.0.1
          DB_PORT: 3306
          DB_DATABASE: tripease_test
          DB_USERNAME: root
          DB_PASSWORD: root
        run: |
          mysql -h 127.0.0.1 -P 3306 -u root -proot -e "CREATE DATABASE IF NOT EXISTS tripease_test;"
          mysql -h 127.0.0.1 -P 3306 -u root -proot tripease_test < database/schema.sql

      - name: Run PHPUnit tests
        env:
          DB_HOST: 127.0.0.1
          DB_NAME: tripease_test
          DB_USER: root
          DB_PASS: root
        run: |
          if [ -f "vendor/bin/phpunit" ]; then
            vendor/bin/phpunit --configuration phpunit.xml --coverage-text
          else
            echo "PHPUnit not found, skipping tests..."
          fi

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: test-results-php${{ matrix.php-version }}
          path: tests/results/

  # Build & Package
  build:
    name: Build Application
    runs-on: ubuntu-latest
    needs: [code-quality, test]

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: mbstring, pdo, pdo_mysql, gd, zip
          tools: composer:v2

      - name: Install production dependencies
        run: composer install --prefer-dist --no-dev --optimize-autoloader

      - name: Create build info
        run: |
          echo "Build Date: $(date)" > build-info.txt
          echo "Commit: ${{ github.sha }}" >> build-info.txt
          echo "Branch: ${{ github.ref_name }}" >> build-info.txt
          echo "Build Number: ${{ github.run_number }}" >> build-info.txt

      - name: Create deployment package
        run: |
          mkdir -p dist
          rsync -av --progress . dist/ \
            --exclude .git \
            --exclude .github \
            --exclude tests \
            --exclude node_modules \
            --exclude .env \
            --exclude .gitignore \
            --exclude phpunit.xml \
            --exclude composer.lock \
            --exclude "all mds"
          cd dist && zip -r ../tripease-${{ github.sha }}.zip .

      - name: Upload build artifact
        uses: actions/upload-artifact@v3
        with:
          name: tripease-build
          path: tripease-${{ github.sha }}.zip
          retention-days: 30

  # Deploy to Staging (on develop branch)
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: [build]
    if: github.ref == 'refs/heads/develop' && github.event_name == 'push'

    steps:
      - name: Download build artifact
        uses: actions/download-artifact@v3
        with:
          name: tripease-build

      - name: Deploy to staging via FTP
        continue-on-error: true
        uses: SamKirkland/FTP-Deploy-Action@4.3.0
        with:
          server: ${{ secrets.STAGING_FTP_SERVER }}
          username: ${{ secrets.STAGING_FTP_USERNAME }}
          password: ${{ secrets.STAGING_FTP_PASSWORD }}
          local-dir: ./
          server-dir: /public_html/staging/

      - name: Run database migrations (if needed)
        run: |
          echo "Database migrations would run here"
          # Add your migration commands

      - name: Clear application cache
        run: |
          echo "Cache clearing would happen here"

      - name: Notify deployment
        if: always()
        continue-on-error: true
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          text: "Staging deployment ${{ job.status }}"
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}

  # Deploy to Production (on main branch)
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [build]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
      - name: Download build artifact
        uses: actions/download-artifact@v3
        with:
          name: tripease-build

      - name: Extract build
        run: unzip tripease-${{ github.sha }}.zip -d deploy

      - name: Deploy via SSH/SFTP
        continue-on-error: true
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.PRODUCTION_HOST }}
          username: ${{ secrets.PRODUCTION_USERNAME }}
          key: ${{ secrets.PRODUCTION_SSH_KEY }}
          source: "deploy/*"
          target: "/var/www/tripease"
          strip_components: 1

      - name: Run post-deployment commands
        continue-on-error: true
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.PRODUCTION_HOST }}
          username: ${{ secrets.PRODUCTION_USERNAME }}
          key: ${{ secrets.PRODUCTION_SSH_KEY }}
          script: |
            cd /var/www/tripease
            # Set proper permissions
            chmod -R 755 .
            chmod -R 777 uploads
            # Clear opcache if needed
            # php artisan cache:clear (if using Laravel-style commands)
            echo "Deployment completed successfully"

      - name: Health check
        run: |
          echo "Performing health check..."
          curl -f https://tripease.com/ || echo "Health check endpoint not available"

      - name: Create GitHub Release
        if: success()
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ github.run_number }}
          name: Release v${{ github.run_number }}
          body: |
            Automated release from commit ${{ github.sha }}

            Changes in this release:
            ${{ github.event.head_commit.message }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Notify deployment success
        if: success()
        continue-on-error: true
        uses: 8398a7/action-slack@v3
        with:
          status: success
          text: "‚úÖ Production deployment successful!"
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}

      - name: Notify deployment failure
        if: failure()
        continue-on-error: true
        uses: 8398a7/action-slack@v3
        with:
          status: failure
          text: "‚ùå Production deployment failed!"
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}

  # Performance Testing (Optional)
  performance-test:
    name: Performance Testing
    runs-on: ubuntu-latest
    needs: [deploy-staging]
    if: github.ref == 'refs/heads/develop'

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Run Lighthouse CI
        uses: treosh/lighthouse-ci-action@v9
        with:
          urls: |
            https://staging.tripease.com
            https://staging.tripease.com/search.php
          uploadArtifacts: true
          temporaryPublicStorage: true

  # Automated Rollback (on failure)
  rollback:
    name: Automated Rollback
    runs-on: ubuntu-latest
    needs: [deploy-production]
    if: failure() && github.ref == 'refs/heads/main'

    steps:
      - name: Rollback deployment
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.PRODUCTION_HOST }}
          username: ${{ secrets.PRODUCTION_USERNAME }}
          key: ${{ secrets.PRODUCTION_SSH_KEY }}
          script: |
            cd /var/www/tripease
            # Restore from backup
            if [ -d "../tripease.backup" ]; then
              rm -rf *
              cp -r ../tripease.backup/* .
              echo "Rollback completed"
            else
              echo "No backup found for rollback"
            fi

      - name: Notify rollback
        continue-on-error: true
        uses: 8398a7/action-slack@v3
        with:
          status: custom
          custom_payload: |
            {
              text: 'üîÑ Automatic rollback initiated due to deployment failure'
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}
