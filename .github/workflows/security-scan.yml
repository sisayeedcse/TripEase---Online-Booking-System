name: Security Scan

on:
  schedule:
    # Run weekly on Mondays at 9 AM UTC
    - cron: "0 9 * * 1"
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  dependency-scan:
    name: Dependency Security Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: "7.4"
          tools: composer:v2

      - name: Install dependencies
        run: composer install --prefer-dist --no-progress

      - name: Run Composer Audit
        run: |
          composer audit --format=json > security-report.json || true
          cat security-report.json

      - name: Upload security report
        uses: actions/upload-artifact@v3
        with:
          name: security-report
          path: security-report.json

  code-scan:
    name: Code Security Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v2
        with:
          languages: "javascript"

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v2

      - name: Check for hardcoded secrets
        continue-on-error: false
        run: |
          echo "Scanning for hardcoded secrets..."

          # Check for common secret patterns
          if grep -rn "api_key\|secret_key\|private_key\|password.*=.*['\"]" --include="*.php" --exclude-dir=vendor . | grep -v "config.php\|config/"; then
            echo "âš ï¸ Warning: Potential hardcoded secrets found"
          fi

          # Check for AWS keys
          if grep -rn "AKIA[0-9A-Z]{16}" --include="*.php" --exclude-dir=vendor .; then
            echo "âŒ AWS Access Key found!"
            exit 1
          fi

          echo "âœ… No obvious secrets found"

      - name: Check file upload security
        run: |
          echo "Checking file upload security..."
          grep -rn "move_uploaded_file" --include="*.php" --exclude-dir=vendor . | while read -r line; do
            if ! echo "$line" | grep -q "finfo_file\|MIME"; then
              echo "âš ï¸ File upload without MIME validation: $line"
            fi
          done

  vulnerability-scan:
    name: Vulnerability Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: "fs"
          scan-ref: "."
          format: "sarif"
          output: "trivy-results.sarif"

      - name: Upload Trivy results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: "trivy-results.sarif"

  security-report:
    name: Generate Security Report
    runs-on: ubuntu-latest
    needs: [dependency-scan, code-scan, vulnerability-scan]
    if: always()

    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v3
        with:
          name: security-report

      - name: Generate summary
        run: |
          echo "# ðŸ”’ Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Date: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "- Dependency Scan: ${{ needs.dependency-scan.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Code Scan: ${{ needs.code-scan.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Vulnerability Scan: ${{ needs.vulnerability-scan.result }}" >> $GITHUB_STEP_SUMMARY

      - name: Notify security team
        if: failure()
        continue-on-error: true
        uses: 8398a7/action-slack@v3
        with:
          status: failure
          text: "ðŸš¨ Security scan found vulnerabilities!"
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}
