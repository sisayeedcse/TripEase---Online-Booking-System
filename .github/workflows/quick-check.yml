name: Quick CI Check

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

jobs:
  quick-check:
    name: Quick Validation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: "7.4"
          extensions: mbstring, pdo, pdo_mysql

      - name: Check PHP version
        run: php -v

      - name: Validate PHP syntax
        run: |
          echo "Checking PHP syntax..."
          find . -name "*.php" -not -path "./vendor/*" | while read file; do
            php -l "$file" || exit 1
          done
          echo "✅ All PHP files are syntactically correct"

      - name: Check project structure
        run: |
          echo "Validating project structure..."
          [ -f "composer.json" ] && echo "✅ composer.json found" || echo "⚠️ composer.json not found"
          [ -f "index.php" ] && echo "✅ index.php found" || echo "❌ index.php not found"
          [ -d "config" ] && echo "✅ config directory found" || echo "❌ config directory not found"
          [ -d "database" ] && echo "✅ database directory found" || echo "❌ database directory not found"
          [ -f "database/schema.sql" ] && echo "✅ database schema found" || echo "⚠️ database schema not found"

      - name: Install Composer dependencies
        continue-on-error: true
        run: |
          if [ -f "composer.json" ]; then
            composer install --prefer-dist --no-progress || composer update --prefer-dist --no-progress
            echo "✅ Composer dependencies installed"
          else
            echo "⚠️ No composer.json file, skipping..."
          fi

      - name: Check for common issues
        run: |
          echo "Checking for common code issues..."

          # Check for PHP short tags
          if grep -r "<?[^php]" --include="*.php" --exclude-dir=vendor . 2>/dev/null; then
            echo "⚠️ Warning: Short PHP tags found"
          else
            echo "✅ No short PHP tags"
          fi

          # Check for eval usage
          if grep -r "eval(" --include="*.php" --exclude-dir=vendor . 2>/dev/null; then
            echo "⚠️ Warning: eval() usage found"
          else
            echo "✅ No eval() usage"
          fi

          echo "Quick check completed!"

      - name: Summary
        run: |
          echo "✅ Quick CI check passed successfully!"
          echo "Project structure is valid and PHP syntax is correct."
